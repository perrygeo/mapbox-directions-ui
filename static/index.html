<!DOCTYPE html>
<html lang="en">
<head>
    <title>Main</title>
    <meta content="application">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <link type="text/css" rel="stylesheet" href="typebase.css">
    <!-- <link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <!-- <link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/paper/bootstrap.min.css"> -->
    <link type="text/css" rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.css" />
    <link type="text/css" rel="stylesheet" href="main.css">
</head>
<body>

<div id="main"></div>
<div id="map"></div>

<script type="text/javascript" src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript">
    // Set up Elm div
    var node = document.getElementById('main');
    var app = Elm.Main.embed(node);

    // Write callbacks for incoming Elm Ports
    app.ports.setBbox.subscribe(function(bbox) {
        var sw = new mapboxgl.LngLat(bbox[0], bbox[1]);
        var ne = new mapboxgl.LngLat(bbox[2], bbox[3]);
        var bounds = new mapboxgl.LngLatBounds(sw, ne);
        map.fitBounds(bounds, { padding: 80 });
    });
    app.ports.resultsToMap.subscribe(function(features) {
        var newData = {
            "type": "FeatureCollection",
            "features": features
        };
        map.getSource('results').setData(newData);
    });
    app.ports.destinationsToMap.subscribe(function(features) {
        var newData = {
            "type": "FeatureCollection",
            "features": features
        };
        map.getSource('destinations').setData(newData);
    });
    app.ports.routesToMap.subscribe(function(features) {
        var newData = {
            "type": "FeatureCollection",
            "features": features
        };
        map.getSource('routes').setData(newData);
    });

    // TODO send data (bbox?) back to Elm
    // app.ports.toElm.send("heyo");


    // Set up MapboxGLJS map element
    mapboxgl.accessToken = 'pk.eyJ1IjoicGVycnlnZW8iLCJhIjoiNjJlNTZmNTNjZTFkZTE2NDUxMjg2ZDg2ZDdjMzI5NTEifQ.-f-A9HuHrPZ7fHhlZxYLHQ';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [0, 0],
        maxZoom: 14,
        zoom: 1
    });

    map.on('load', function () {

        // Results
        map.addLayer({
            "id": "results",
            "type": "circle",
            "paint": {
                "circle-radius": 4,
                "circle-color": "#448"
            },
            "source": {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
            },
        });

        // Routes
        map.addLayer({
            "id": "routes",
            "type": "line",
            "layout": {
                "line-join": "round",
                "line-cap": "round"
            },
            "paint": {
                "line-color": "#224",
                "line-width": 3
            },
            "source": {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
            }
        });

        // Destinations
        map.addLayer({
           "id": "destinations",
           "type": "circle",
           "paint": {
               "circle-radius": 7,
               "circle-color": "#242"
           },
           "source": {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
           }
        });
    });
</script>


</body>
</html>
