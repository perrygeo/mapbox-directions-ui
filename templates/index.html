<!DOCTYPE html>
<html lang="en">
<head>
    <title>Main</title>
    <meta content="application">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <link type="text/css" rel="stylesheet" href="main.css">
    <link type="text/css" rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.css" />
</head>
<body>

<div id="main"></div>
<div id="map"></div>

<script type="text/javascript" src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript">
    // Set up Elm div
    var node = document.getElementById('main');
    var app = Elm.Main.embed(node);

    // Write callbacks for incoming Elm Ports
    app.ports.setBbox.subscribe(function(bbox) {
        var sw = new mapboxgl.LngLat(bbox[0], bbox[1]);
        var ne = new mapboxgl.LngLat(bbox[2], bbox[3]);
        var bounds = new mapboxgl.LngLatBounds(sw, ne);
        map.fitBounds(bounds, { padding: 80 });
    });
    app.ports.resultsToMap.subscribe(function(features) {
        var newData = {
            "type": "FeatureCollection",
            "features": features
        };
        map.getSource('results').setData(newData);
    });
    app.ports.destinationsToMap.subscribe(function(features) {
        var newData = {
            "type": "FeatureCollection",
            "features": features
        };
        map.getSource('destinations').setData(newData);
    });

    // TODO send data back to Elm
    // app.ports.toElm.send("heyo");


    // Set up MapboxGLJS map element
    mapboxgl.accessToken = 'pk.eyJ1IjoicGVycnlnZW8iLCJhIjoiNjJlNTZmNTNjZTFkZTE2NDUxMjg2ZDg2ZDdjMzI5NTEifQ.-f-A9HuHrPZ7fHhlZxYLHQ';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [0, 0],
        zoom: 1
    });

    map.on('load', function () {
        map.addLayer({
            "id": "results",
            "type": "circle",
            "paint": {
                "circle-radius": 10,
                "circle-color": "#007cbf"
            },
            "source": {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
            },
        });
        map.addLayer({
            "id": "destinations",
            "type": "circle",
            "paint": {
                "circle-radius": 14,
                "circle-color": "#ffff00"
            },
            "source": {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
            },
        });
    });
</script>


</body>
</html>
